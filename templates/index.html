{% extends "base.html" %}

{% block title %}Chat - Atendente virtual{% endblock %}

{% block styles %}
<style>
    #chat-window {
        height: 400px;
        overflow-y: auto;
        background-color: #fcfcfc;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
    }
    .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 80%;
    }
    .user-message {
        background-color: #0d6efd;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 2px;
    }
    .ai-message {
        background-color: #e9ecef;
        color: #333;
        margin-right: auto;
        border-bottom-left-radius: 2px;
    }
    .typing-dots {
        display: inline-block;
        animation: blink 1.4s infinite;
    }
    @keyframes blink {
        0%, 20% { opacity: 0.2; }
        50% { opacity: 1; }
        100% { opacity: 0.2; }
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-chat-dots"></i> Atendente Virtual</h5>
            </div>
            
            <div class="card-body">
                <div id="chat-window" class="mb-3 d-flex flex-column">
                    <!-- Mensagens serão carregadas aqui -->
                </div>

                <div class="input-group">
                    <input type="text" id="user-input" class="form-control" placeholder="Digite sua mensagem..." aria-label="Mensagem do usuário">
                    <button class="btn btn-primary" type="button" id="send-btn">
                        Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    // Chave para localStorage
    const STORAGE_KEY = 'chat_history';

    // Função para salvar histórico no localStorage
    function saveHistory(message, isUser) {
        let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        history.push({ text: message, isUser: isUser, timestamp: Date.now() });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    }

    // Função para carregar histórico do localStorage
    function loadHistory() {
        let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        history.forEach(msg => {
            addMessage(msg.text, msg.isUser, false); // false = não salvar novamente
        });
    }

    // Função para adicionar mensagem na tela
    function addMessage(text, isUser, shouldSave = true) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message');
        msgDiv.classList.add(isUser ? 'user-message' : 'ai-message');
        msgDiv.innerText = text;
        chatWindow.appendChild(msgDiv);
        
        // Scroll automático para o final
        chatWindow.scrollTop = chatWindow.scrollHeight;

        // Salvar no histórico se necessário
        if (shouldSave) {
            saveHistory(text, isUser);
        }
    }

    // Função para mostrar indicador de digitando
    function showTypingIndicator() {
        const typingIndicator = document.createElement('div');
        typingIndicator.classList.add('message', 'ai-message');
        typingIndicator.id = 'typing-indicator';
        typingIndicator.innerHTML = '<span class="typing-dots">Digitando...</span>';
        chatWindow.appendChild(typingIndicator);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // Função para remover indicador de digitando
    function removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
            indicator.remove();
        }
    }

    // Função para buscar mensagem inicial da IA
    async function getInitialMessage() {
        try {
            const response = await fetch('/enviar_mensagem', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mensagem: 'Olá' })
            });

            const data = await response.json();
            
            if (data.resposta) {
                addMessage(data.resposta, false);
            } else {
                addMessage("Olá! Como posso ajudar?", false);
            }
        } catch (error) {
            console.error('Erro ao buscar mensagem inicial:', error);
            addMessage("Olá! Como posso ajudar?", false);
        }
    }

    async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        // Desabilita o botão para evitar envios duplicados
        sendBtn.disabled = true;
        userInput.disabled = true;

        // Limpa o input e mostra a mensagem do usuário
        userInput.value = '';
        addMessage(message, true);
        
        // Mostra indicador de "digitando..."
        showTypingIndicator();

        try {
            const response = await fetch('/enviar_mensagem', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mensagem: message })
            });

            const data = await response.json();
            
            // Remove o indicador de digitando
            removeTypingIndicator();
            
            if (data.resposta) {
                addMessage(data.resposta, false);
            } else {
                addMessage("Erro: Não foi possível obter resposta.", false);
            }
        } catch (error) {
            console.error('Erro:', error);
            removeTypingIndicator();
            addMessage("Erro de conexão com o servidor.", false);
        } finally {
            // Reabilita o botão e o input
            sendBtn.disabled = false;
            userInput.disabled = false;
            userInput.focus();
        }
    }

    // Eventos de clique e tecla Enter
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMessage();
    });

    // Ao carregar a página, sempre reinicia para manter sincronismo com a sessão Flask
    window.addEventListener('DOMContentLoaded', function() {
        // Limpa o histórico local para sincronizar com a sessão do servidor
        localStorage.removeItem(STORAGE_KEY);
        // Busca mensagem inicial da IA
        getInitialMessage();
    });
</script>
{% endblock %}